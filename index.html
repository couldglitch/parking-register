<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADHI PARASAKTHI CYCLE STAND Registration</title>
    <!-- Font Awesome CDN for WhatsApp and parking icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Noto Sans Tamil for Tamil text -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil&display=swap" rel="stylesheet">
    <!-- SheetJS for Excel processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans Tamil', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: #f4f4f4;
            overflow: auto;
        }
        .form-box {
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 350px;
            width: 90%;
            border: 1px solid #e0e0e0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .form-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        }
        .logo {
            display: block;
            text-align: center;
            margin-bottom: 15px;
        }
        .logo i {
            font-size: 40px;
            color: #25D366;
        }
        .form-box h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #000000;
            font-size: 24px;
            font-weight: 600;
            letter-spacing: 1px;
        }
        .form-box label {
            display: block;
            margin: 15px 0 5px;
            color: #000000;
            font-size: 14px;
            font-weight: 500;
        }
        .form-box input {
            width: 100%;
            padding: 12px;
            border: 1px solid #000000;
            border-radius: 8px;
            background: #ffffff;
            color: #000000;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-box input::placeholder {
            color: #666666;
        }
        .form-box input:focus {
            outline: none;
            border-color: #333333;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
        }
        .form-box button {
            width: 100%;
            padding: 12px;
            background: #25D366;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        .form-box button:hover {
            background: #1ebe57;
            transform: scale(1.02);
        }
        .form-box button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        #qrCode {
            margin-top: 20px;
            border: 5px solid #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
            max-width: 100%;
            cursor: pointer;
        }
        .error {
            color: #e63946;
            font-size: 12px;
            margin-top: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .error.show {
            opacity: 1;
        }
        .loading {
            display: none;
            margin-top: 10px;
            font-style: italic;
            color: #555;
        }
        .loading::before {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #555;
            border-top-color: #25D366;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .language-toggle {
            text-align: center;
            margin-top: 15px;
        }
        .language-toggle button {
            background: none;
            border: none;
            color: #000000;
            font-size: 14px;
            cursor: pointer;
            text-decoration: underline;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            max-width: 300px;
            width: 80%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .modal-content h3 {
            margin-bottom: 20px;
            color: #000000;
        }
        .modal-content button {
            width: 45%;
            margin: 5px;
        }
        @media (max-width: 400px) {
            .form-box {
                padding: 20px;
            }
            .form-box h2 {
                font-size: 20px;
            }
            .form-box input, .form-box button {
                font-size: 14px;
            }
            .logo i {
                font-size: 32px;
            }
            .modal-content {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="modal" id="languageModal">
        <div class="modal-content">
            <h3>Select Language / மொழியைத் தேர்ந்தெடு</h3>
            <button onclick="setLanguage('en')">English</button>
            <button onclick="setLanguage('ta')">தமிழ்</button>
        </div>
    </div>

    <div class="form-box">
        <div class="logo">
            <i class="fas fa-parking" aria-label="Parking logo"></i>
        </div>
        <h2 id="title1">ADHI PARASAKTHI CYCLE STAND</h2>
        <h2 id="title2">Registration</h2>
        <form id="parkingForm">
            <label for="name" id="nameLabel">Name:</label>
            <input type="text" id="name" name="name" placeholder="Enter your name" required aria-required="true" aria-describedby="nameError">
            <div id="nameError" class="error" aria-live="polite"></div>
            <label for="phone" id="phoneLabel">Phone Number:</label>
            <input type="tel" id="phone" name="phone" placeholder="e.g., 9360320051" required aria-required="true" aria-describedby="phoneError">
            <div id="phoneError" class="error" aria-live="polite"></div>
            <label for="bikeNumber" id="bikeNumberLabel">Vehicle Number Plate:</label>
            <input type="text" id="bikeNumber" name="bikeNumber" placeholder="e.g., MH12AB1234 or DL1T1234" required aria-required="true" aria-describedby="bikeNumberError">
            <div id="bikeNumberError" class="error" aria-live="polite"></div>
            <div id="qrError" class="error" aria-live="polite"></div>
            <button type="button" id="generateQrButton" onclick="generateQRCode()"><span id="generateQrText">Generate QR Code</span></button>
            <button type="submit" id="whatsappButton"><i class="fab fa-whatsapp"></i> <span id="submitText">Send to WhatsApp</span></button>
        </form>
        <p id="loading" class="loading">Generating QR code...</p>
        <img id="qrCode" alt="Contact QR Code">
        <div class="language-toggle">
            <button onclick="showLanguageModal()">Change Language / மொழியை மாற்று</button>
        </div>
    </div>

    <script>
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    var filteredData = jsonData.filter(row => row.some(filledCell));
                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }
                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error(e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }

        const DEFAULT_WHATSAPP_RECIPIENT = '+919360320051';
        let isQrCodeGenerated = false;

        const translations = {
            en: {
                title1: 'ADHI PARASAKTHI CYCLE STAND',
                title2: 'Registration',
                nameLabel: 'Name:',
                namePlaceholder: 'Enter your name',
                nameError: 'Name can only contain letters, spaces, apostrophes, or hyphens.',
                phoneLabel: 'Phone Number:',
                phonePlaceholder: 'e.g., 9360320051',
                phoneError: 'Phone number must be 10 digits.',
                bikeNumberLabel: 'Vehicle Number Plate:',
                bikeNumberPlaceholder: 'e.g., MH12AB1234 or DL1T1234',
                bikeNumberError: 'Vehicle number must be a valid registration number (e.g., MH12AB1234, DL1T1234, 21BH1234AA, or ABC123).',
                qrError: 'Error generating QR code.',
                generateQrText: 'Generate QR Code',
                submitText: 'Send to WhatsApp',
                sendingText: 'Sending...',
                successMessage: 'Registration sent successfully!',
                errorMessage: 'Unable to open WhatsApp. Please ensure WhatsApp is installed or check your network connection.',
                confirmReset: 'Do you want to reset the form?'
            },
            ta: {
                title1: 'ஆதி பராசக்தி சைக்கிள் ஸ்டாண்ட்',
                title2: 'பதிவு',
                nameLabel: 'பெயர்:',
                namePlaceholder: 'உங்கள் பெயரை உள்ளிடவும்',
                nameError: 'பெயரில் எழுத்துக்கள், இடைவெளிகள், அப்போஸ்ட்ரோப்கள் அல்லது ஹைபன்கள் மட்டுமே இருக்க வேண்டும்.',
                phoneLabel: 'தொலைபேசி எண்:',
                phonePlaceholder: 'எ.கா., 9360320051',
                phoneError: 'தொலைபேசி எண் 10 இலக்கங்களாக இருக்க வேண்டும்.',
                bikeNumberLabel: 'வாகன எண் பலகை:',
                bikeNumberPlaceholder: 'எ.கா., MH12AB1234 அல்லது DL1T1234',
                bikeNumberError: 'வாகன எண் ஒரு செல்லுபடியாகும் பதிவு எண்ணாக இருக்க வேண்டும் (எ.கா., MH12AB1234, DL1T1234, 21BH1234AA, அல்லது ABC123).',
                qrError: 'QR குறியீடு உருவாக்குவதில் பிழை.',
                generateQrText: 'QR குறியீடு உருவாக்கு',
                submitText: 'வாட்ஸ்அப்பிற்கு அனுப்பு',
                sendingText: 'அனுப்பப்படுகிறது...',
                successMessage: 'பதிவு வெற்றிகரமாக அனுப்பப்பட்டது!',
                errorMessage: 'வாட்ஸ்அப்பை திறக்க முடியவில்லை. வாட்ஸ்அப் நிறுவப்பட்டுள்ளதா அல்லது உங்கள் நெட்வொர்க்கை சரிபார்க்கவும்.',
                confirmReset: 'படிவத்தை மீட்டமைக்க விரும்புகிறீர்களா?'
            }
        };

        const elements = {
            title1: document.getElementById('title1'),
            title2: document.getElementById('title2'),
            nameLabel: document.getElementById('nameLabel'),
            nameInput: document.getElementById('name'),
            nameError: document.getElementById('nameError'),
            phoneLabel: document.getElementById('phoneLabel'),
            phoneInput: document.getElementById('phone'),
            phoneError: document.getElementById('phoneError'),
            bikeNumberLabel: document.getElementById('bikeNumberLabel'),
            bikeNumberInput: document.getElementById('bikeNumber'),
            bikeNumberError: document.getElementById('bikeNumberError'),
            qrError: document.getElementById('qrError'),
            generateQrButton: document.getElementById('generateQrButton'),
            generateQrText: document.getElementById('generateQrText'),
            whatsappButton: document.getElementById('whatsappButton'),
            submitText: document.getElementById('submitText'),
            qrCode: document.getElementById('qrCode'),
            loading: document.getElementById('loading')
        };

        function setLanguage(lang) {
            localStorage.setItem('language', lang);
            const t = translations[lang];
            elements.title1.textContent = t.title1;
            elements.title2.textContent = t.title2;
            elements.nameLabel.textContent = t.nameLabel;
            elements.nameInput.placeholder = t.namePlaceholder;
            elements.nameError.textContent = t.nameError;
            elements.phoneLabel.textContent = t.phoneLabel;
            elements.phoneInput.placeholder = t.phonePlaceholder;
            elements.phoneError.textContent = t.phoneError;
            elements.bikeNumberLabel.textContent = t.bikeNumberLabel;
            elements.bikeNumberInput.placeholder = t.bikeNumberPlaceholder;
            elements.bikeNumberError.textContent = t.bikeNumberError;
            elements.qrError.textContent = t.qrError;
            elements.generateQrText.textContent = t.generateQrText;
            elements.submitText.textContent = t.submitText;
            document.getElementById('languageModal').style.display = 'none';
        }

        function showLanguageModal() {
            document.getElementById('languageModal').style.display = 'flex';
        }

        const savedLanguage = localStorage.getItem('language') || 'en';
        setLanguage(savedLanguage);

        if (!localStorage.getItem('language')) {
            showLanguageModal();
        }

        function validateName(name) {
            const nameRegex = /^[A-Za-z\s'-]+$/;
            return nameRegex.test(name);
        }

        function validatePhone(phone) {
            const phoneRegex = /^\d{10}$/;
            return phoneRegex.test(phone.replace(/\s/g, ''));
        }

        function validateBikeNumber(bikeNumber) {
            const bikeNumberRegex = /^[A-Z]{1,3}[- ]?\d{1,2}[- ]?(?:[A-Z]{0,2}[- ]?)?\d{1,4}|[A-Z0-9]{1,7}$/i;
            return bikeNumberRegex.test(bikeNumber);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function updateButtonStates() {
            const isNameValid = validateName(elements.nameInput.value.trim());
            const isPhoneValid = validatePhone(elements.phoneInput.value);
            const isBikeNumberValid = validateBikeNumber(elements.bikeNumberInput.value.trim().toUpperCase());
            elements.whatsappButton.disabled = !(isNameValid && isPhoneValid && isBikeNumberValid && isQrCodeGenerated);
            elements.generateQrButton.disabled = isQrCodeGenerated;
        }

        elements.nameInput.addEventListener('input', debounce(() => {
            isQrCodeGenerated = false;
            elements.qrCode.style.display = 'none';
            elements.nameError.classList.remove('show');
            updateButtonStates();
        }, 300));

        elements.phoneInput.addEventListener('input', debounce(() => {
            isQrCodeGenerated = false;
            elements.qrCode.style.display = 'none';
            elements.phoneError.classList.remove('show');
            updateButtonStates();
        }, 300));

        elements.bikeNumberInput.addEventListener('input', debounce(() => {
            isQrCodeGenerated = false;
            elements.qrCode.style.display = 'none';
            elements.bikeNumberError.classList.remove('show');
            updateButtonStates();
        }, 300));

        function generateQRCode() {
            const lang = localStorage.getItem('language') || 'en';
            const t = translations[lang];

            elements.nameError.classList.remove('show');
            elements.phoneError.classList.remove('show');
            elements.bikeNumberError.classList.remove('show');
            elements.qrError.classList.remove('show');
            elements.qrCode.style.display = 'none';
            elements.loading.style.display = 'block';
            isQrCodeGenerated = false;

            const name = elements.nameInput.value.trim();
            const phone = elements.phoneInput.value.replace(/\s/g, '');
            const bikeNumber = elements.bikeNumberInput.value.trim().toUpperCase();

            let isValid = true;

            if (!validateName(name)) {
                elements.nameError.classList.add('show');
                isValid = false;
            }
            if (!validatePhone(phone)) {
                elements.phoneError.classList.add('show');
                isValid = false;
            }
            if (!validateBikeNumber(bikeNumber)) {
                elements.bikeNumberError.classList.add('show');
                isValid = false;
            }

            if (!isValid) {
                elements.loading.style.display = 'none';
                updateButtonStates();
                return;
            }

            const data = [{ Name: name, Phone: phone, BikeNumber: bikeNumber }];
            const jsonString = JSON.stringify(data);
            const qrCodeUrl = `https://quickchart.io/qr?text=${encodeURIComponent(jsonString)}&size=200`;

            fetch(qrCodeUrl)
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch QR code');
                    return response.blob();
                })
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    elements.qrCode.src = url;
                    elements.qrCode.style.display = 'block';
                    elements.loading.style.display = 'none';
                    isQrCodeGenerated = true;
                    updateButtonStates();
                })
                .catch(error => {
                    elements.qrError.textContent = t.qrError;
                    elements.qrError.classList.add('show');
                    elements.qrCode.style.display = 'none';
                    elements.loading.style.display = 'none';
                    isQrCodeGenerated = false;
                    updateButtonStates();
                });
        }

        elements.qrCode.addEventListener('click', () => {
            const link = document.createElement('a');
            link.href = elements.qrCode.src;
            link.download = 'parking_qr_code.png';
            link.click();
        });

        document.getElementById('parkingForm').addEventListener('submit', function(event) {
            event.preventDefault();

            if (elements.whatsappButton.disabled) return;

            const lang = localStorage.getItem('language') || 'en';
            const t = translations[lang];

            elements.nameError.classList.remove('show');
            elements.phoneError.classList.remove('show');
            elements.bikeNumberError.classList.remove('show');
            elements.qrError.classList.remove('show');

            const name = elements.nameInput.value.trim();
            const phone = elements.phoneInput.value.replace(/\s/g, '');
            const bikeNumber = elements.bikeNumberInput.value.trim().toUpperCase();

            let isValid = true;

            if (!validateName(name)) {
                elements.nameError.classList.add('show');
                isValid = false;
            }
            if (!validatePhone(phone)) {
                elements.phoneError.classList.add('show');
                isValid = false;
            }
            if (!validateBikeNumber(bikeNumber)) {
                elements.bikeNumberError.classList.add('show');
                isValid = false;
            }

            if (!isValid) return;

            elements.whatsappButton.disabled = true;
            elements.submitText.textContent = t.sendingText;

            const message = encodeURIComponent(`Name: ${name}\nPhone: ${phone}\nVehicle Number: ${bikeNumber}`);
            const whatsappUrl = `https://wa.me/${DEFAULT_WHATSAPP_RECIPIENT.replace('+', '')}?text=${message}`;

            try {
                window.open(whatsappUrl, '_blank');
                setTimeout(() => {
                    if (confirm(t.confirmReset)) {
                        document.getElementById('parkingForm').reset();
                        elements.qrCode.style.display = 'none';
                        isQrCodeGenerated = false;
                        elements.whatsappButton.disabled = true;
                        elements.generateQrButton.disabled = false;
                        elements.submitText.textContent = t.submitText;
                        updateButtonStates();
                        alert(t.successMessage);
                    } else {
                        elements.whatsappButton.disabled = false;
                        elements.submitText.textContent = t.submitText;
                    }
                }, 1000);
            } catch (error) {
                console.error('Error opening WhatsApp URL:', error);
                elements.whatsappButton.disabled = false;
                elements.submitText.textContent = t.submitText;
                alert(t.errorMessage);
            }
        });

        updateButtonStates();
    </script>
</body>
</html>
